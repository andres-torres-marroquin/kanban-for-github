<html>
    <head>
        <title>Kanban for GitHub</title>
        <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
<style>
.phase {
     vertical-align: top;
     display: inline-block;
     border: 1px solid blue;
}
.issue {
     border: 1px solid red;
}
.issue-header {
 cursor: move;
 padding: 4px 7px;
 margin: 2px;
 border-radius: 4px;
 -moz-border-radius: 4px;
 -webkit-border-radius: 4px;
}
.issue-header a .ui-icon {
 float: left;
 padding-right: 2px;
 display: none;
}
.issue:hover .issue-header a .ui-icon {
 display: inline;
}
.issue-assignee {
 float: right;
 font-size: 60%;
}
.ui-state-highlight.issue-placeholder {
 margin: 10px 5px;
}
.issue-assignee img {
 margin-left: 5px;
}
.issue-assignee-name {
 padding: 4px 0;
 float: left;
}
span.ui-icon {
 float: left;
 margin-right: 2px;
}
.issue-name {
 margin: 5px 7px;
 overflow: hidden;
 font-size: 75%;
}
.issue-assignee {
 float: right;
}
</style>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://www.webtoolkit.info/djs/webtoolkit.base64.js"></script>
        <script type="text/javascript" src="media/js/JSON-js/json2.js"></script>
        <script type="text/javascript" src="https://raw.github.com/jquery/jquery-tmpl/master/jquery.tmpl.min.js"></script>
<script id="issue-template" type="text/x-jquery-tmpl">
    <div class="issue ui-widget-content" data-number="${number}">
    	<div class="issue-header ui-state-default">
       		<a href="${html_url}">
                <span class="ui-icon ui-icon-search"></span>
                <strong><div class="issue-name">
                    ${number}
                </div></strong>
            </a>
            &nbsp;${title}
            <div class="issue-assignee">
            	{{if assignee}}
        	        <span class="issue-assignee-name">${assignee.login}</span>
    	            <img src="${assignee.avatar_url}" width="20" height="20"/>
	            {{else}}
                	<span class="issue-assignee-name">Not assigned</span>
            	{{/if}}
        	</div>
        </div>
    </div>
</script>
<script id="phase-template" type="text/x-jquery-tmpl">
    <div id="phase${number}" class="phase" style="width: ${percentage}%" data-name="${name}">
        <h3>${name}</h3>
        <div class="issues"></div>
    </div>
</script>
        <script type="text/javascript">
var GITHUB_API_URL = 'https://api.github.com/repos/';
var client = null;

function GitHubApi(user, repo, auth) {
    this.user = user;
    this.repo = repo;
    this.is_auth_enabled = auth.username && auth.password;
    this.auth = "Basic " + Base64.encode(auth.username + ":" + auth.password);
    this.base_url = GITHUB_API_URL + this.user + '/' + this.repo + '/';
}

GitHubApi.prototype._clean_params = function (parameters) {
    $.each(parameters, function(i, v) {
        if (v==null)
            delete parameters[i];
    });
}

GitHubApi.prototype.get_issues = function(parameters) {
    var response = null;
    var parameters = parameters || {};    
    this._clean_params(parameters);
    var me = this;
    $.ajax({
        url: this.base_url + 'issues',
        async: false,
        data: parameters,
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
            $('#issues').html('');
            response = data;
        }
    });
    return response;
}

GitHubApi.prototype.get_labels = function(parameters) {
    var response = null;
    var parameters = parameters || {};
    var me = this;
    $.ajax({
        url: this.base_url + 'labels',
        async: false,
        data: parameters,
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
            response = data;
        }
    });
    return response;
}

GitHubApi.prototype.add_labels_to_issue = function(issue_id, labels) {
    var me = this;
    $.ajax({
        url: this.base_url + 'issues/' + issue_id + '/labels',
        type: 'POST',
        data: JSON.stringify(labels),
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
        }
    });
}

GitHubApi.prototype.get_labels_for_issue = function(issue_id) {
    var me = this;
    var response = null;
    $.ajax({
        url: this.base_url + 'issues/' + issue_id + '/labels',
		async: false,
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
			response = data;
        }
    });
    return response;
}

GitHubApi.prototype.replace_labels_for_issue = function(issue_id, labels) {
    var me = this;
    $.ajax({
        url: this.base_url + 'issues/' + issue_id + '/labels',
        type: 'PUT',
        data: JSON.stringify(labels),
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
        }
    });
}

function get_phases(labels) {
    var phases = [];
    $.each(labels, function(i, label){
        if(/Phase #\d+ - .+/.test(label.name))
            phases.push(label)
    });
    phases.sort(function(a, b) {
        if (a.name > b.name) 
    		return 1;
    	else if (a.name < b.name)
    	    return -1;
    	return 0;
    })
    return phases;
}

function draw_phases(phases){
    var percentage = 99 / phases.length;
    $('#phases').html('');
    $.each(phases, function(i, phase) {
        phase.number = /\d+/.exec(phase.name);
        phase.percentage = percentage;
        $('#phase-template').tmpl(phase).appendTo("#phases");
        draw_issues(phase);
    });
}

function draw_issues(phase) {
    var issues = client.get_issues({labels: phase.name});
    $.each(issues, function(i, issue) {
        $('#issue-template').tmpl(issue).appendTo("#phase" + phase.number + " .issues");
    });
}

function remove_phases(labels) {
    var result = []
    $.each(labels, function(i, label){
        if(!/Phase #\d+ - .+/.test(label.name))
            result.push(label)
    });
    return result;
}

function get_labels_name(labels) {
    var result = []
    $.each(labels, function(i, label){
        if(!/Phase #\d+ - .+/.test(label.name))
            result.push(label.name)
    });
    return result;
}

$(function(){
    $('#loginform').submit(function(){
        var $this = $(this);
        var username = $this.find('[name=username]').val();
        var password = $this.find('[name=password]').val();
        var repo_user = $this.find('[name=repo-user]').val();
        var repo_name = $this.find('[name=repo-name]').val();
        
        auth = {
            username: username,
            password: password
        };
        
        client = new GitHubApi(repo_user, repo_name, auth);
        var labels = client.get_labels();
        var phases = get_phases(labels);
        draw_phases(phases);
        
        $('.issues').sortable({
	        connectWith: ".issues",
    	    distance: 15,
        	revert: true,
	        opacity: 0.9,
    	    placeholder: "ui-state-highlight issue-placeholder",
			stop: function(event, ui){
		    	var $element = $(ui.item);
			    var number = $element.attr('data-number');
			    var phase = $element.parents('.phase').attr('data-name');
			    labels = client.get_labels_for_issue(number);
		    	labels = remove_phases(labels);
			    labels = get_labels_name(labels);
			    labels.push(phase);		    
			    client.replace_labels_for_issue(number, labels);
			}
		}).disableSelection();
        
        return false;
    }).hide().submit();
    
    $('#login').click(function(){
        $('#loginform').toggle();
    });
    
    $('#tabs').tabs();
    
});
        </script>
    </head>
    <body>
        <h1>Kanban for GitHub</h1>
        <a id="login" href="#">login</a>
        <form id="loginform">
            <p>
                <label for="username"><br />Username
                    <input type="text" name="username" value="andres-torres-marroquin"/>
                </label>
            </p>
            <p>
                <label for="username"><br />Password
                    <input type="password" name="password" value=""/>
                </label>
            </p>
            <p>
                <label for="username"><br />Repo User
                    <input type="text" name="repo-user" value="andres-torres-marroquin"/>
                </label>
            </p>
            <p>
                <label for="username"><br />Repo Name
                    <input type="text" name="repo-name" value="testing-github-api"/>
                </label>
            </p>
            <input type="submit"/>
        </form>
        
        <div id="tabs">
            <ul>
                <li><a href="#phases">Phases</a></li>
                <li><a href="#labels">Labels</a></li>
            </ul>
            <div id="phases"></div>
            <div id="labels"></div>
        </div>
    </body>
</html>