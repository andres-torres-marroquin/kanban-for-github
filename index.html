<html>
    <head>
        <title>Kanban for GitHub</title>
        <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
<style>
.phase {
     vertical-align: top;
     display: inline-block;
     border: 1px solid blue;
}
.issue {
     border: 1px solid red;
}
</style>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://www.webtoolkit.info/djs/webtoolkit.base64.js"></script>
        <script type="text/javascript" src="media/js/JSON-js/json2.js"></script>
        <script type="text/javascript" src="https://raw.github.com/jquery/jquery-tmpl/master/jquery.tmpl.min.js"></script>
<script id="issue-template" type="text/x-jquery-tmpl">
    <div class="issue">
        <h4>#${number} - ${title}
            {{if assignee}} 
            <a href="${assignee.url}">
                ${assignee.login}
                <img src="${assignee.avatar_url}" width="20" height="20"/>
            </a>
            <h6>{{/if}}</h6>
            {{each labels}}
                ${$value.name}<br/>
            {{/each}}
        </h4>
        ${body}
    </div>
</script>
<script id="phase-template" type="text/x-jquery-tmpl">
    <div id="phase${number}" class="phase" style="width: ${percentage}%">
        <h3>${name}</h3>
    </div>
</script>
        <script type="text/javascript">
var GITHUB_API_URL = 'https://api.github.com/repos/';
var client = null;

function GitHubApi(user, repo, auth) {
    this.user = user;
    this.repo = repo;
    this.is_auth_enabled = auth.username && auth.password;
    this.auth = "Basic " + Base64.encode(auth.username + ":" + auth.password);
    this.base_url = GITHUB_API_URL + this.user + '/' + this.repo + '/';
}

GitHubApi.prototype._clean_params = function (parameters) {
    $.each(parameters, function(i, v) {
        if (v==null)
            delete parameters[i];
    });
}

GitHubApi.prototype.get_issues = function(parameters) {
    var response = null;
    var parameters = parameters || {};    
    this._clean_params(parameters);
    var me = this;
    $.ajax({
        url: this.base_url + 'issues',
        async: false,
        data: parameters,
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
            $('#issues').html('');
            response = data;
        }
    });
    return response;
}

GitHubApi.prototype.get_labels = function(parameters) {
    var response = null;
    var parameters = parameters || {};
    var me = this;
    $.ajax({
        url: this.base_url + 'labels',
        async: false,
        data: parameters,
        beforeSend: function(xhr) {
            if(me.is_auth_enabled)
                xhr.setRequestHeader("Authorization", me.auth)
        },
        success: function(data) {
            response = data;
        }
    });
    return response;
}

function get_phases(labels) {
    var phases = [];
    $.each(labels, function(i, v){
        if(/Phase #\d+ - .+/.test(v.name))
            phases.push(v)
    });    
    return phases;
}

function draw_phases(phases){
    var percentage = 99 / phases.length;
    $('#phases').html('');
    $.each(phases, function(i, phase) {
        phase.number = /\d+/.exec(phase.name);
        phase.percentage = percentage;
        $('#phase-template').tmpl(phase).appendTo("#phases");
        draw_issues(phase);
    });
}

function draw_issues(phase) {
    var issues = client.get_issues({labels: phase.name});
    $.each(issues, function(i, issue) {
        $('#issue-template').tmpl(issue).appendTo("#phase" + phase.number);
    });
}

$(function(){
    $('#loginform').submit(function(){
        var $this = $(this);
        var username = $this.find('[name=username]').val();
        var password = $this.find('[name=password]').val();
        var repo_user = $this.find('[name=repo-user]').val();
        var repo_name = $this.find('[name=repo-name]').val();
        
        auth = {
            username: username,
            password: password
        };
        
        client = new GitHubApi(repo_user, repo_name, auth);
        //var issues = client.get_issues();
        //console.log(issues);
        var labels = client.get_labels();
        console.log(labels);
        var phases = get_phases(labels);
        console.log(phases);
        draw_phases(phases);
        
        return false;
    }).hide().submit();
    
    $('#login').click(function(){
        $('#loginform').toggle();
    });
    
    $('#tabs').tabs();
});
        </script>
    </head>
    <body>
        <h1>Kanban for GitHub</h1>
        <a id="login" href="#">login</a>
        <form id="loginform">
            <p>
                <label for="username"><br />Username
                    <input type="text" name="username" value="andres-torres-marroquin"/>
                </label>
            </p>
            <p>
                <label for="username"><br />Password
                    <input type="password" name="password" value=""/>
                </label>
            </p>
            <p>
                <label for="username"><br />Repo User
                    <input type="text" name="repo-user" value="andres-torres-marroquin"/>
                </label>
            </p>
            <p>
                <label for="username"><br />Repo Name
                    <input type="text" name="repo-name" value="testing-github-api"/>
                </label>
            </p>
            <input type="submit"/>
        </form>
        
        <div id="tabs">
            <ul>
                <li><a href="#phases">Phases</a></li>
                <li><a href="#labels">Labels</a></li>
            </ul>
            <div id="phases"></div>
            <div id="labels"></div>
        </div>
    </body>
</html>